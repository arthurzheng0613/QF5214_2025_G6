import requests
import pandas as pd
from datetime import datetime
import time

# ç¾å›½æœ¬åœŸçš„ç»çº¬åº¦èŒƒå›´ï¼ˆä¸åŒ…å«å¤å¨å¤·å’Œé˜¿æ‹‰æ–¯åŠ ï¼‰
latitude_min, latitude_max = 24, 49   # çº¬åº¦èŒƒå›´ 24Â°N - 49Â°N
longitude_min, longitude_max = -125, -66  # ç»åº¦èŒƒå›´ -125Â°W - -66Â°W
grid_step = 1  # ç½‘æ ¼é—´éš” 1Â°ï¼ˆæ¯ 1Â° é‡‡æ ·ä¸€ä¸ªç‚¹ï¼‰

# æ—¶é—´èŒƒå›´
start_date = "20180101"  # 2018 å¹´ 1 æœˆ 1 æ—¥
end_date = "20241231"    # 2024 å¹´ 12 æœˆ 31 æ—¥

# NASA POWER API
api_url = "https://power.larc.nasa.gov/api/temporal/daily/point"

# å˜é‡åˆ—è¡¨
variables = [
    "SLP", "T10M", "T10M_MAX", "T10M_MIN", "T10M_RANGE", "TO3", "TQV",
    "TROPPB", "TROPQ", "TROPT", "TSOIL1", "TSOIL2"
]

# éå†æ‰€æœ‰å˜é‡
for variable in variables:
    print(f"ğŸ“ æ­£åœ¨è·å–å˜é‡ {variable} ...")

    # åˆå§‹åŒ–åˆ—è¡¨å­˜å‚¨è¯¥å˜é‡çš„æ‰€æœ‰æ•°æ®
    data_records = []

    # è®¡ç®—æ‰€æœ‰çš„çº¬åº¦å’Œç»åº¦ç‚¹
    latitudes = range(latitude_min, latitude_max + 1, grid_step)
    longitudes = range(longitude_min, longitude_max + 1, grid_step)

    print(f"ğŸ“ é¢„è®¡è¯·æ±‚ {len(latitudes) * len(longitudes)} ä¸ªé‡‡æ ·ç‚¹çš„æ•°æ®")

    # éå†æ•´ä¸ªåŒºåŸŸï¼ˆæŒ‰ç½‘æ ¼åˆ’åˆ†ï¼‰
    for lat in latitudes:
        for lon in longitudes:
            print(f"ğŸ“ æ­£åœ¨è·å– {lat}N, {lon}W çš„ {variable} æ•°æ® ...")

            # æ„é€  API è¯·æ±‚å‚æ•°
            params = {
                "parameters": variable,
                "community": "RE",
                "longitude": lon,
                "latitude": lat,
                "start": start_date,
                "end": end_date,
                "format": "JSON"
            }

            # å‘é€è¯·æ±‚
            response = requests.get(api_url, params=params)

            if response.status_code == 200:
                data = response.json()

                if "properties" in data and "parameter" in data["properties"]:
                    # è·å–å˜é‡æ•°æ®
                    var_data = data["properties"]["parameter"].get(variable, {})

                    # éå†æ—¶é—´æˆ³
                    for timestamp, value in var_data.items():
                        data_records.append([lat, lon, timestamp, value])

                    print(f"âœ… {lat}N, {lon}W çš„ {variable} æ•°æ®æˆåŠŸè·å–")
                else:
                    print(f"âš ï¸ {lat}N, {lon}W çš„ {variable} æ•°æ®ç¼ºå¤±")

            else:
                print(f"âŒ {lat}N, {lon}W è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : {response.status_code}, é”™è¯¯ä¿¡æ¯: {response.text}")

            # ä¼‘æ¯ 0.5 ç§’ï¼Œé˜²æ­¢ API é™æµ
            time.sleep(0.5)

    # è½¬æ¢æ•°æ®ä¸º DataFrame
    df = pd.DataFrame(data_records, columns=["Latitude", "Longitude", "Timestamp", variable])

    # æ ¼å¼åŒ–æ—¶é—´åˆ—
    df["Timestamp"] = pd.to_datetime(df["Timestamp"], format="%Y%m%d")

    # ç”Ÿæˆ CSV æ–‡ä»¶å
    output_filename = f"US_{variable}_20180101_20241231_Daily.csv"
    df.to_csv(output_filename, index=False)

    print(f"âœ… {variable} æ•°æ®å·²ä¿å­˜ä¸º {output_filename}")

print("âœ… æ‰€æœ‰å˜é‡çš„æ•°æ®è·å–å®Œæˆï¼")
